name: SonarQube Code Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  sonar:
    runs-on: windows-latest

    # Dummy values so workflow runs
    env:
      SONAR_HOST_URL: "http://dummy-sonarqube-url"
      SONAR_TOKEN: "dummy-token-123456"
      SONAR_PROJECT_KEY: "dummy-project-key"
      SONAR_PROJECT_NAME: "Dummy Project"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Sonar variables
        shell: powershell
        run: |
          if (-not $env:SONAR_HOST_URL) { Write-Error "SONAR_HOST_URL missing"; exit 1 }
          if (-not $env:SONAR_TOKEN) { Write-Error "SONAR_TOKEN missing"; exit 1 }
          if (-not $env:SONAR_PROJECT_KEY) { Write-Error "SONAR_PROJECT_KEY missing"; exit 1 }
          if (-not $env:SONAR_PROJECT_NAME) { Write-Error "SONAR_PROJECT_NAME missing"; exit 1 }
          Write-Host "Sonar variables validated"

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: Restore NuGet packages
        shell: powershell
        run: nuget restore "SampleWebApplication.sln"

      - name: Locate MSBuild.exe
        shell: powershell
        run: |
          Write-Host "Locating MSBuild..."
          $vswhere = "$env:ProgramFiles\Microsoft Visual Studio\Installer\vswhere.exe"

          if (Test-Path $vswhere) {
            $install = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath 2>$null

            if ($install) {
              $msbuild = Join-Path $install "MSBuild\Current\Bin\MSBuild.exe"
              if (Test-Path $msbuild) {
                Write-Host "MSBuild found at $msbuild"
                Add-Content -Path $env:GITHUB_ENV -Value "MSBUILD_PATH=$msbuild"
                exit 0
              }
            }
          }

          Write-Error "MSBuild not found"
          exit 1

      - name: Install SonarScanner (dotnet)
        shell: powershell
        run: |
          dotnet tool install --global dotnet-sonarscanner --version 5.12.0 `
            || dotnet tool update --global dotnet-sonarscanner --version 5.12.0

          $env:PATH = "$env:USERPROFILE\.dotnet\tools;" + $env:PATH
          Write-Host "SonarScanner installed"
