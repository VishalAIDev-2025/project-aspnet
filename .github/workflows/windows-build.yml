name: Build ASP.NET Web App

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: Restore Packages
        shell: powershell
        run: nuget restore "SampleWebApplication.sln"

      - name: Locate MSBuild
        id: locate-msbuild
        shell: powershell
        run: |
          # Find vswhere.exe if available
          $vswhere = Join-Path $env:ProgramFiles 'Microsoft Visual Studio\Installer\vswhere.exe'
          $msbuildPath = $null

          if (Test-Path $vswhere) {
            Write-Host "Using vswhere to locate Visual Studio..."
            $installPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath 2>$null
            if ($installPath) {
              $candidate = Join-Path $installPath 'MSBuild\Current\Bin\MSBuild.exe'
              if (Test-Path $candidate) { $msbuildPath = $candidate }
            }
          }

          if (-not $msbuildPath) {
            Write-Host "vswhere not found or did not return a path â€” trying fallback paths..."
            $fallbacks = @(
              'C:\Program Files\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MSBuild.exe',
              'C:\Program Files\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MSBuild.exe',
              'C:\Program Files\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe',
              'C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MSBuild.exe',
              'C:\Program Files (x86)\MSBuild\14.0\Bin\MSBuild.exe'
            )
            foreach ($p in $fallbacks) {
              if (Test-Path $p) { $msbuildPath = $p; break }
            }
          }

          if (-not $msbuildPath) {
            Write-Error "MSBuild not found on this runner. Searched vswhere and fallback paths."
            # optional debug: list Visual Studio folder contents
            if (Test-Path 'C:\Program Files\Microsoft Visual Studio') {
              Write-Host "Debug: listing C:\Program Files\Microsoft Visual Studio"
              Get-ChildItem 'C:\Program Files\Microsoft Visual Studio' -Force | ForEach-Object { Write-Host $_.FullName }
            }
            exit 1
          }

          Write-Host "MSBuild found at: $msbuildPath"
          # Export to GITHUB_ENV in a reliable way
          Add-Content -Path $env:GITHUB_ENV -Value "MSBUILD_PATH=$msbuildPath"

      - name: Build Solution
        shell: powershell
        run: |
          if (-not $env:MSBUILD_PATH) {
            Write-Error "MSBUILD_PATH is not set. Locate step may have failed."
            exit 1
          }
          Write-Host "Building solution with MSBuild: $env:MSBUILD_PATH"
          & "$env:MSBUILD_PATH" "SampleWebApplication.sln" /p:Configuration=Release

      - name: Publish Web Project
        shell: powershell
        run: |
          Write-Host "Publishing web project using MSBuild..."
          & "$env:MSBUILD_PATH" ".\SampleWebApplication\SampleWebApplication.csproj" /p:Configuration=Release /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=false /p:SkipInvalidConfigurations=true

      - name: Create Artifact ZIP
        shell: powershell
        run: |
          $publishSrc = ".\SampleWebApplication\obj\Release\Package\PackageTmp"
          if (!(Test-Path $publishSrc)) {
            Write-Host "Publish folder not found: $publishSrc"
            exit 1
          }
          if (Test-Path "publish") { Remove-Item "publish" -Recurse -Force }
          New-Item -ItemType Directory -Path publish | Out-Null
          robocopy $publishSrc publish /E | Out-Null
          if (Test-Path "publish.zip") { Remove-Item "publish.zip" -Force }
          Compress-Archive -Path (Join-Path (Get-Item publish).FullName '*') -DestinationPath publish.zip
          Write-Host "publish.zip created successfully"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: publish.zip
