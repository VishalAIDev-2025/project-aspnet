name: SonarQube Code Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  sonar:
    runs-on: windows-latest
    env:
      # NOTE: for production, move SONAR_TOKEN into repo secrets and reference via ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: "https://sonarcloud.io"
      SONAR_TOKEN: "25f0b32cdd9160d498bbaa922462f89275769c74"
      SONAR_PROJECT_KEY: "VishalAIDev-2025_project-aspnet"
      SONAR_PROJECT_NAME: "project-aspnet"
      SONAR_ORGANIZATION: "vishalaidev-2025"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: Ensure MSBuild is available
        id: setup-msbuild
        uses: microsoft/setup-msbuild@v1

      - name: Export MSBUILD_PATH (action output or vswhere fallback)
        shell: powershell
        run: |
          # Try action output first
          $ms = '${{ steps.setup-msbuild.outputs.msbuild-path }}'
          if (-not [string]::IsNullOrEmpty($ms)) {
            Write-Host "Using msbuild path from action output: $ms"
            Add-Content -Path $env:GITHUB_ENV -Value ("MSBUILD_PATH=" + $ms)
            exit 0
          }

          Write-Host "setup-msbuild did not return msbuild-path; trying vswhere fallback..."
          $vswhere = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio\Installer\vswhere.exe"
          if (Test-Path $vswhere) {
            $inst = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -property installationPath
            if ($inst) {
              $candidate = Join-Path $inst "MSBuild\Current\Bin\MSBuild.exe"
              if (-not (Test-Path $candidate)) {
                $candidate = Get-ChildItem -Path (Join-Path $inst "MSBuild") -Recurse -Filter "MSBuild.exe" -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
              }
              if ($candidate -and (Test-Path $candidate)) {
                Write-Host "Found MSBuild via vswhere: $candidate"
                Add-Content -Path $env:GITHUB_ENV -Value ("MSBUILD_PATH=" + $ca
