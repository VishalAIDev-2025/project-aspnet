name: Build ASP.NET Web App

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup NuGet
        uses: nuget/setup-nuget@v1

      - name: Restore Packages
        shell: powershell
        run: nuget restore "SampleWebApplication.sln"

      - name: Build Solution
        shell: powershell
        run: |
          $msbuild = "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe"
          if (!(Test-Path $msbuild)) {
            Write-Error "MSBuild not found at $msbuild"
            exit 1
          }
          & $msbuild "SampleWebApplication.sln" /p:Configuration=Release

      - name: Publish Web Project
        shell: powershell
        run: |
          $msbuild = "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MSBuild.exe"
          if (!(Test-Path $msbuild)) {
            Write-Error "MSBuild not found at $msbuild"
            exit 1
          }
          & $msbuild ".\SampleWebApplication\SampleWebApplication.csproj" `
            /p:Configuration=Release `
            /p:DeployOnBuild=true `
            /p:WebPublishMethod=Package `
            /p:PackageAsSingleFile=false `
            /p:SkipInvalidConfigurations=true

      - name: Create Artifact ZIP
        shell: powershell
        run: |
          $publishPath = ".\SampleWebApplication\obj\Release\Package\PackageTmp"

          if (!(Test-Path $publishPath)) {
            Write-Host "❌ Publish folder not found. Check project path."
            exit 1
          }

          if (Test-Path "publish") { Remove-Item "publish" -Recurse -Force }
          New-Item -ItemType Directory -Path publish | Out-Null

          robocopy $publishPath publish /E | Out-Null

          if (Test-Path "publish.zip") { Remove-Item "publish.zip" -Force }
          Compress-Archive -Path (Join-Path (Get-Item publish).FullName '*') -DestinationPath publish.zip

          Write-Host "✅ publish.zip created successfully"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: publish.zip
